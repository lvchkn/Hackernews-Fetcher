# Copilot Instructions

## Project Overview
This repository contains a **.NET ** service written in **C#**.
It is structured into the following layers:

- **Program.cs** - Entry point of the service, where the web host is configured and run
- **Worker.cs** - Background service responsible for polling the Algolia Hackernews endpoints for new stories, processing them and publishing to a RabbitMQ queue
- **DI.cs** - All `IServiceCollection` extension methods go here
- **Controllers/** – Minimal API style endpoints
- **Services/** – Main logic for processing the fetched stories, retrieving comments for them and saving the info to MongoDB
- **Repos/** – Repositories that abstract away the MongoDB collection queries
- **Models/** – For simplicity, both entities and DTOs go here
- **Utils/** – `Mapperly` source-generated mappings

Concurrency, async programming, immutability, and DI best practices are followed.

---

## Coding Conventions
- Use **the latest version of C#**, **nullable reference types**, and **async/await** when possible.
- Follow **.NET style guidelines**:
    - `PascalCase` for public members.
    - `camelCase` for locals and parameters.
    - Prefix private readonly fields with `_`.
- Favor **records** for immutable DTOs and **classes** for entities.
- Avoid unnecessary abstractions (“you aren’t gonna need it” principle).
- Use **dependency injection** instead of statics or singletons.
- Use minimal API style rather than full-fledged controllers

---

## Testing & Quality
- Use **xUnit** as the testing framework for everything, including assertions.
- Mock dependencies using **NSubstitute**.
- Prefer testing behavior and domain logic, not implementation details.

---

## Copilot-Specific Guidance
When generating or editing code, Copilot should:
- **Follow existing folder structure and DI patterns**.
- **Favor readability** and **consistency** over cleverness.
- Suggest **small, focused methods** and **self-documenting names**.
- Avoid re-implementing existing helper methods or frameworks.
- When unsure, prefer idiomatic .NET patterns.

If asked to:
- **Add a feature** → create DTOs, handlers, and endpoints following existing conventions.
- **Fix a bug** → prefer minimal, clear fixes that maintain current design.
- **Write tests** → ensure Arrange-Act-Assert structure and expressive assertions.
- **Document** → write XML comments for public APIs and summarize intent clearly.

---

## Dependencies

- **MongoDB** for data persistence
- **RabbitMQ** for publishing the data that can be consumed by other services
- **Mapperly** for source-generated mappings
- **Serilog** for structured logging
- **Prometheus** for exposing metrics
- **Swagger / Swashbuckle** for API docs
- **Docker Compose** for orchestration and deployment

---

## Observability

### Metrics

The following custom metrics are instrumented:

- **hn_fetcher_api_requests_total** - counter of all outbound API requests (split by successful/failed)
- **hn_fetcher_api_errors_total** - counter of all outbound API request's errors/exceptions
- **hn_fetcher_api_request_duration_seconds** - histogram showing the duration of outbound API requests in seconds

**Prometheus** scrapes the `/metrics` endpoint and stores the metrics in a time-series database.
**Grafana** is used to visualize the metrics on a dashboard.

### Logs

- **Serilog** writes logs to the console sink
- **FluentBit** collects the logs and sends it to VictoriaLogs
- **VictoriaLogs** acts as the logs storage and allows querying them
- **Grafana** is used to visualize the VictoriaLogs queries

---